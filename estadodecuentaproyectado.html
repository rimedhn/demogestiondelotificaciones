<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESTADO DE CUENTA - CLIENTE</title>
  <link rel="icon" href="https://github.com/rimedhn/demogestiondelotificaciones/blob/main/Lotificacion%20vector.jpg?raw=true" type="image/x-icon">
  <style>
    body { font-family: Arial, sans-serif; background: #fff; padding: 0; margin: 0; }
    .estado-cuenta-container { width: 8in; margin: auto; background: #fff; min-height: 10in; padding: 0.6in 0.5in; position: relative; }
    .header-logo-table { width: 100%; border: none; }
    .logo-img { width: 82px; height: 82px; object-fit: contain; }
    .empresa { font-size: 23px; font-weight: bold; letter-spacing: 1px; }
    .empresa-info { font-size: 13px; color: #333; }
    h2, .seccion-titulo { font-size: 18px; font-weight: bold; margin:15px 0 6px 0; text-align: left; }
    .datos-basicos { margin:10px 0 8px 0; font-size: 16px; }
    .desc-lote-table-custom { width: 100%; table-layout: fixed; border:none; font-size: 15px; margin-top:8px; }
    .desc-lote-table-custom td { border: none; background: #fff; padding:4px 6px; vertical-align:top; }
    .desc-lote-left { width:55%; }
    .desc-lote-right { width:45%; text-align: right; }
    .cuota-saldo-area { width:100%; display:flex; flex-direction: column; align-items: flex-end; margin-bottom:5px; margin-top:6px;}
    .tasa-line { font-size:14px; color:#333; margin-bottom:4px; }
    .cuota-line { font-size: 16px; font-weight: bold; color: #1D70B7; padding-bottom:2px;}
    .saldo-inicial {font-size:16px; font-weight:bold; color:#d77f00;}
    .pagos-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 0px; }
    .pagos-table th { padding: 2px 4px; border: 1px solid #222; background: #f4f4f4; font-size: 12px !important; text-align: center !important; white-space:nowrap; }
    .pagos-table td { padding: 2px 4px; border: 1px solid #222; text-align: right; white-space:nowrap; }
    .pagos-table tbody tr:nth-child(even) { background: #fafafa; }
    .pagos-table td.izq, .pagos-table th.izq { text-align: left; white-space:normal; }
    /* Ajuste de ancho de columnas */
    .pagos-table th.fecha-col, .pagos-table td.fecha-col { width: 9%; }
    .pagos-table th.mes-col, .pagos-table td.mes-col { width: 12%; }
    .pagos-table th.pago-col, .pagos-table td.pago-col { width: 8%; }
    .pagos-table th.nocol-col, .pagos-table td.nocol-col { width: 5%; }
    .pagos-table th.capital-col, .pagos-table td.capital-col { width: 11%; }
    .pagos-table th.int-col, .pagos-table td.int-col { width: 10%; }
    .pagos-table th.cuota-col, .pagos-table td.cuota-col { width: 10%; }
    .pagos-table th.mora-col, .pagos-table td.mora-col { width: 8%; }
    .pagos-table th.abonocap-col, .pagos-table td.abonocap-col { width: 8%; }
    .pagos-table th.saldo-col, .pagos-table td.saldo-col { width: 11%; }
    .pagos-table td.cuota-nivelada, .pagos-table th.cuota-nivelada { background: #ffe385; font-weight: bold; }
    .pagos-table td.saldo-actual { font-weight: bold; color: #e01313; background: #ffe385; }
    .monto-letras { text-align: left; font-weight: bold; font-size: 15px; margin: 3px 0 5px 0; }

    /* Row states: pagado (paid) and proyectado (projected) */
    .pagos-table tr.pagado td { color: #0b6b0b; background: #eaffea; }
    .pagos-table tr.proyectado td { color: #000; background: transparent; }

    @media print {
      body, .estado-cuenta-container { background: #fff !important; }
      .estado-cuenta-container { page-break-after: always; }
      .fecha-contrato { color: #e01313 !important;}
      .pagos-table { font-size: 10px !important; }
      .pagos-table th { font-size: 11px !important; }
    }
  </style>
</head>
<body>
  <div class="estado-cuenta-container">
    <table class="header-logo-table">
      <tr>
        <td style="width:100px;vertical-align:top;">
          <img class="logo-img" src="https://github.com/rimedhn/demogestiondelotificaciones/blob/main/Lotificacion%20vector.jpg?raw=true" alt="Logo" />
        </td>
        <td>
          <div class="empresa">NOMBRE DEL PROYECTO</div>
          <div class="empresa-info">RTN. 0000-0000-000000</div>
          <div class="empresa-info">DIRECCION DEL PROYECTO.</div>
          <div class="empresa-info">gerencia@proyecto.com Teléfonos: +000 0000-0000</div>
        </td>
      </tr>
    </table>
    <hr>
    <h2>ESTADO DE CUENTA</h2>
    <div class="datos-basicos">
      <span><b>Cliente/Estipulante:</b> <span id="NombreCliente"></span></span><br>
      <span><b>Comprador(es):</b> <span id="NombreComprador"></span></span>
    </div>

    <div class="seccion-titulo">DESCRIPCIÓN DEL LOTE / PRÉSTAMO</div>
    <!-- Ajustado distribución de campos -->
    <table class="desc-lote-table-custom">
      <tr>
        <td class="desc-lote-left">
          <b>Valor del terreno:</b> <span id="Monto"></span><br>
          <b>Valor de la Prima:</b> <span id="Prima"></span><br>
          <b>Valor Financiado:</b> <span id="Financiado"></span>
        </td>
        <td class="desc-lote-right">
          <b>Lotificación:</b> <span id="NombreLotificacion"></span><br>
          <b>Número de lote:</b> <span id="NoLoteybloque"></span><br>
          <b>Fecha del contrato:</b> <span class="fecha-contrato" id="FechaAprobado"></span>
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <b>Plazo de financiamiento:</b> <span id="PlazoLetras"></span>
        </td>
      </tr>
    </table>

    <div class="seccion-titulo" style="margin-top:20px;">Detalle de pagos</div>
    <div class="cuota-saldo-area">
      <div class="tasa-line">Tasa: <span id="TasaDisplay"></span></div>
      <div class="cuota-line">CUOTA NIVELADA MENSUAL: <span id="CuotaNiveladaCalculo"></span></div>
      <div class="saldo-inicial">SALDO INICIAL: <span id="SaldoInicial"></span></div>
    </div>

    <table class="pagos-table" id="pagosTable">
      <thead>
        <tr>
          <th class="izq fecha-col">Fecha</th>
          <th class="mes-col">Mes</th>
          <th class="pago-col">Pago</th>
          <th class="nocol-col">No.</th>
          <th class="capital-col">Capital</th>
          <th class="int-col">Interés</th>
          <th class="cuota-col">Cuota</th>
          <th class="mora-col">Mora</th>
          <th class="abonocap-col">Abono Capital</th>
          <th class="saldo-col saldo-actual">Saldo Actual</th>
        </tr>
      </thead>
      <tbody id="detallePagosBody"></tbody>
    </table>
  </div>

  <script>
    const openSheetPrestamo = "https://opensheet.elk.sh/1hWjZAz-kUculGo_13F96ryJVLJ9G4_70DlLlMSj8SvM/Prestamo";
    const openSheetAbono = "https://opensheet.elk.sh/1hWjZAz-kUculGo_13F96ryJVLJ9G4_70DlLlMSj8SvM/Abono prestamo";

    function getQueryParam(param) {
      var urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
    function fetchJSON(url){ return fetch(url).then(r=>r.json()); }

    function formatCurrency(num){ if(isNaN(num))return "L 0.00"; return "L "+parseFloat(num).toLocaleString('es-HN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function parseNumber(val){ if(val==undefined || val==null) return 0; val=(""+val).replace("L","").replace("$","").replace(/,/g,"").trim(); return parseFloat(val)||0; }

    // Parse dd/mm/yyyy -> Date
    function parseDateDMY(s) {
      if (!s) return null;
      let parts = s.split("/");
      if (parts.length === 3) {
        let dd = parseInt(parts[0],10);
        let mm = parseInt(parts[1],10);
        let yyyy = parseInt(parts[2],10);
        if (!isNaN(dd) && !isNaN(mm) && !isNaN(yyyy)) {
          return new Date(yyyy,mm-1,dd);
        }
      }
      return null;
    }
    function formatFechaDMY(fechaStr){
      let d = parseDateDMY(fechaStr);
      if (!d) return fechaStr || "";
      let dd = d.getDate()>9?d.getDate():"0"+d.getDate();
      let mm = (d.getMonth()+1)>9?(d.getMonth()+1):"0"+(d.getMonth()+1);
      let yyyy=d.getFullYear();
      return dd+"/"+mm+"/"+yyyy;
    }

    function formatDateObjDMY(d){
      if(!d || !(d instanceof Date)) return "";
      let dd = d.getDate()>9?d.getDate():"0"+d.getDate();
      let mm = (d.getMonth()+1)>9?(d.getMonth()+1):"0"+(d.getMonth()+1);
      let yyyy=d.getFullYear();
      return dd+"/"+mm+"/"+yyyy;
    }

    // Calcula la abreviatura del mes y año en la secuencia de pagos
    // idx: 0 => primer pago (mes siguiente a la fecha inicial)
    function calcularMesAbrevSecuencialDMY(fechaInicialDMY, idx) {
      let fi = parseDateDMY(fechaInicialDMY);
      if (!fi) return "";
      // Primer pago corresponde al mes siguiente
      let pagoDate = new Date(fi.getFullYear(), fi.getMonth() + 1 + idx, 1);
      const mesesAbrev = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      let nombreMes = mesesAbrev[pagoDate.getMonth()];
      let año = pagoDate.getFullYear();
      return nombreMes + ", " + año;
    }

    // Cálculo de cuota nivelada mensual (anualidad) — ahora detecta si Tasa es anual y la convierte a tasa mensual
    function calcularCuotaNivelada(principal, tasaCampo, plazo){
      if(principal <= 0 || plazo <= 0) return 0;
      let tasaNum = parseFloat(tasaCampo);
      if (isNaN(tasaNum) || tasaNum === 0) return principal / plazo;

      // Interpretación:
      // - si tasaNum > 1: se asume porcentaje anual (ej. 15 -> 15% anual)
      // - si tasaNum > 0 && tasaNum <= 1: se asume decimal anual (ej. 0.15 -> 15% anual)
      // Convertimos a tasa mensual en decimal
      let tasaAnualDecimal;
      if (tasaNum > 1) tasaAnualDecimal = tasaNum / 100.0;
      else tasaAnualDecimal = tasaNum; // ya decimal anual

      let tasaMensual = tasaAnualDecimal / 12.0;
      let r = tasaMensual; // tasa mensual en decimal
      let n = plazo; // meses

      // fórmula de anualidad: cuota = P * (r(1+r)^n) / ((1+r)^n - 1)
      if (r === 0) return principal / n;
      let pow = Math.pow(1 + r, n);
      let cuota = principal * (r * pow) / (pow - 1);
      return cuota;
    }

    async function loadEstadoCuenta() {
      let idprestamo = getQueryParam('idprestamo');
      if (!idprestamo) { alert("Falta el parámetro idprestamo."); return; }

      let [prestamos, abonos] = await Promise.all([
        fetchJSON(openSheetPrestamo),
        fetchJSON(openSheetAbono)
      ]);

      let prestamo = prestamos.find(p => String(p.idprestamo) == String(idprestamo));
      if (!prestamo) { alert("Préstamo no encontrado."); return; }

      // Valores y formato con separador de miles (con prefijo L)
      let monto = parseNumber(prestamo.Monto);
      let prima = parseNumber(prestamo.Prima);
      let valorFinanciado = monto - prima;
      let plazo = parseInt(prestamo.Plazo) || 0;
      let tasaRaw = prestamo.Tasa !== undefined && prestamo.Tasa !== "" ? prestamo.Tasa : 0;
      let cuotaNivelada = calcularCuotaNivelada(valorFinanciado, tasaRaw, plazo);

      document.getElementById("NombreCliente").textContent = prestamo.NombreCliente || "";
      document.getElementById("NombreComprador").textContent = prestamo.NombreComprador || "";
      document.getElementById("NombreLotificacion").textContent = prestamo.NombreLotificacion || "";
      document.getElementById("NoLoteybloque").textContent = prestamo.NoLoteybloque || "";
      document.getElementById("Monto").textContent = formatCurrency(monto);
      document.getElementById("Prima").textContent = formatCurrency(prima);
      document.getElementById("Financiado").textContent = formatCurrency(valorFinanciado);
      document.getElementById("PlazoLetras").textContent = (prestamo.Plazo ? prestamo.Plazo + " Meses" : "");
      document.getElementById("FechaAprobado").textContent = formatFechaDMY(prestamo.FechaAprobado);

      // Mostrar la tasa tal como vino (pero formateada)
      let tasaDisplay = (tasaRaw === null || tasaRaw === undefined || String(tasaRaw).trim() === "") ? "0 %" : (String(tasaRaw).trim() + (String(tasaRaw).toString().includes("%") ? "" : " %"));
      document.getElementById("TasaDisplay").textContent = tasaDisplay;
      document.getElementById("CuotaNiveladaCalculo").textContent = formatCurrency(cuotaNivelada);
      document.getElementById("SaldoInicial").textContent = formatCurrency(valorFinanciado);

      // Ordenar abonos por campo Fecha (dd/mm/yyyy) y excluir Estado "Anulado"
      let abonosPrestamo = abonos
        .filter(a => String(a.Prestamo) == String(idprestamo) && String((a.Estado||"")).trim().toLowerCase() !== "anulado")
        .sort((a,b) => {
          let fa = parseDateDMY(a.Fecha || "") || new Date(0);
          let fb = parseDateDMY(b.Fecha || "") || new Date(0);
          return fa - fb;
        });

      // Construir plan completo (pagos proyectados) y marcar cuales están pagados.
      // Interpretar tasa mensual
      let tasaNum = parseFloat(tasaRaw);
      let tasaAnualDecimal;
      if (isNaN(tasaNum) || tasaNum === 0) tasaAnualDecimal = 0;
      else if (tasaNum > 1) tasaAnualDecimal = tasaNum / 100.0;
      else tasaAnualDecimal = tasaNum;
      let tasaMensual = tasaAnualDecimal / 12.0;

      let tbody = document.getElementById("detallePagosBody");
      tbody.innerHTML = "";

      // Fecha inicio (contrato)
      let fechaAprobado = prestamo.FechaAprobado;
      let fechaAprobadoDate = parseDateDMY(fechaAprobado);

      let saldoActual = valorFinanciado;
      let abIndex = 0; // índice para abonosPrestamo -> asignación secuencial a cuotas

      // Round helper to cents
      function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

      for (let mesIdx = 0; mesIdx < plazo; mesIdx++) {
        // Fecha esperada del pago (usamos día 01 del mes calculado)
        let expectedDate = fechaAprobadoDate ? new Date(fechaAprobadoDate.getFullYear(), fechaAprobadoDate.getMonth() + 1 + mesIdx, 1) : null;
        let fechaMostrarProjected = expectedDate ? formatDateObjDMY(expectedDate) : "";

        // Calcular interés y capital proyectados con saldo actual (antes del pago)
        let interesProy = round2(saldoActual * tasaMensual);
        let cuotaProy = round2(cuotaNivelada);
        let capitalProy = round2(cuotaProy - interesProy);

        // Ajuste en la última cuota para eliminar remanente por redondeo
        if (mesIdx === plazo - 1) {
          capitalProy = round2(saldoActual); // pagar lo que queda
          cuotaProy = round2(interesProy + capitalProy);
        }

        // Ver si hay un abono disponible para asignar a esta cuota (asignación secuencial)
        let assignedAbono = abonosPrestamo[abIndex];

        // Decidimos asignar un abono a la cuota si existe uno no asignado (se asigna en orden cronológico)
        let isPaid = false;
        if (assignedAbono) {
          // Asignamos el abono a esta cuota
          isPaid = true;
          abIndex++;
        }

        let fila = tbody.insertRow(-1);
        if (isPaid) fila.className = "pagado";
        else fila.className = "proyectado";

        // Valores a mostrar
        let pagoMostrar, fechaMostrar, noCuota, capitalMostrar, interesMostrar, cuotaMostrar, moraMostrar, abonoCapitalMostrar;

        noCuota = mesIdx + 1;

        if (isPaid) {
          let ab = assignedAbono;
          pagoMostrar = formatCurrency(parseNumber(ab.Monto));
          fechaMostrar = formatFechaDMY(ab.Fecha) || fechaMostrarProjected;
          // Preferir los valores registrados en el abono cuando existen, sino usar proyección
          capitalMostrar = ab.Capital ? formatCurrency(parseNumber(ab.Capital)) : formatCurrency(capitalProy);
          interesMostrar = ab.Interes ? formatCurrency(parseNumber(ab.Interes)) : formatCurrency(interesProy);
          cuotaMostrar = ab.Cuota ? formatCurrency(parseNumber(ab.Cuota)) : formatCurrency(cuotaProy);
          moraMostrar = ab.Recargo ? formatCurrency(parseNumber(ab.Recargo)) : formatCurrency(0);
          abonoCapitalMostrar = ab["Abono capital"] ? formatCurrency(parseNumber(ab["Abono capital"])) : formatCurrency(0);

          // Actualizar saldo según lo efectivamente abonado (capital + 'Abono capital')
          let capitalNum = ab.Capital ? parseNumber(ab.Capital) : capitalProy;
          let abonoCapNum = ab["Abono capital"] ? parseNumber(ab["Abono capital"]) : 0;
          saldoActual = round2(saldoActual - (capitalNum + abonoCapNum));
        } else {
          // proyectado
          pagoMostrar = formatCurrency(cuotaProy);
          fechaMostrar = fechaMostrarProjected;
          capitalMostrar = formatCurrency(capitalProy);
          interesMostrar = formatCurrency(interesProy);
          cuotaMostrar = formatCurrency(cuotaProy);
          moraMostrar = formatCurrency(0);
          abonoCapitalMostrar = formatCurrency(0);

          // Actualizar saldo con capital proyectado
          saldoActual = round2(saldoActual - capitalProy);
        }

        // Mostrar saldo actual (no negativo)
        let saldoMostrar = saldoActual < 0.005 && saldoActual > -0.005 ? 0 : saldoActual;
        // Crear las celdas en el orden correcto
        fila.insertCell().className = "izq fecha-col"; fila.cells[0].textContent = fechaMostrar || "";
        fila.insertCell().className = "mes-col"; fila.cells[1].textContent = calcularMesAbrevSecuencialDMY(fechaAprobado, mesIdx);
        fila.insertCell().className = "pago-col"; fila.cells[2].textContent = pagoMostrar;
        fila.insertCell().className = "nocol-col"; fila.cells[3].textContent = noCuota;
        fila.insertCell().className = "capital-col"; fila.cells[4].textContent = capitalMostrar;
        fila.insertCell().className = "int-col"; fila.cells[5].textContent = interesMostrar;
        fila.insertCell().className = "cuota-col"; fila.cells[6].textContent = cuotaMostrar;
        fila.insertCell().className = "mora-col"; fila.cells[7].textContent = moraMostrar;
        fila.insertCell().className = "abonocap-col"; fila.cells[8].textContent = abonoCapitalMostrar;
        fila.insertCell().className = "saldo-col saldo-actual"; fila.cells[9].textContent = formatCurrency(saldoMostrar);
      }

      // Si no hay abonos y plazo es 0 (evitar tabla vacía), mostrar una fila con saldo inicial
      if (plazo === 0) {
        let fila = tbody.insertRow(0);
        for (let c=0; c<10; c++) fila.insertCell().textContent = '';
        fila.cells[9].className = "saldo-col saldo-actual";
        fila.cells[9].textContent = formatCurrency(saldoActual);
      }

      // Auto print after render
      setTimeout(function(){ window.print(); }, 600);
    }

    window.onload = loadEstadoCuenta;
  </script>
</body>
</html>
